version: '3.8' # 指定 Docker Compose 文件的版本

services:
  backend:
    build:
      context: .
      dockerfile: ./docker/Dockerfile.server
    volumes:
      - ./api:/app
    ports:
      - '8088:8088'
      - '7001:7001'
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY} #OpenAI API密钥
      - WEAVIATE_URL=${WEAVIATE_URL} #Weaviate URL
      - WEAVIATE_API_KEY=${WEAVIATE_API_KEY} #Weaviate API密钥
      - WEAVIATE_LOCAL_URL=weaviate #Weaviate本地URL
      - WEAVIATE_LOCAL_API_KEY=${WEAVIATE_LOCAL_API_KEY} #Weaviate本地API密钥
      - OPENAI_BASE_URL=${OPENAI_BASE_URL} #OpenAI基础URL
      - OPENAI_API_BASE=${OPENAI_API_BASE} #OpenAI API基础URL
      - ENVIRONMENT=${ENVIRONMENT} #环境设置
      - MYSQL_MIN_CONNECTIONS=${MYSQL_MIN_CONNECTIONS} #MySQL最小连接数
      - MYSQL_MAX_CONNECTIONS=${MYSQL_MAX_CONNECTIONS} #MySQL最大连接数
      - QINIU_BASEURL=${QINIU_BASEURL}
      - QINIU_SK=${QINIU_SK}
      - QINIU_AK=${QINIU_AK}
      - QINIU_BUCKET=${QINIU_BUCKET}
      - MYSQL_HOST=db
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_PORT=${MYSQL_PORT}

    depends_on:
      - db
      - weaviate

  db:
    image: mysql:5.7
    restart: always
    ports:
      - '3306:3306'
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_PASSWORD} #数据库根密码
      MYSQL_DATABASE: ${MYSQL_DATABASE} #数据库名称
      MYSQL_USER: ${MYSQL_USER} #数据库用户名
      MYSQL_PASSWORD: ${MYSQL_PASSWORD} #数据库密码
    volumes:
      - db_data:/var/lib/mysql # 使用卷来持久化数据
      - ./api/init.sql:/docker-entrypoint-initdb.d/init.sql # 挂载初始化脚本

  weaviate:
    image: semitechnologies/weaviate
    ports:
      - '8080:8080'
      - '50051:50051'
    volumes:
      - weaviate_data:/var/lib/weaviate # 使用 Docker 卷持久化数据
    environment:
      - QUERY_DEFAULTS_LIMIT=25 # 设置默认查询限制
      - AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED='true' # 启用匿名访问
      - ENABLE_MODULES='text2vec-openai' # 启用 OpenAI 模块

volumes:
  db_data: {} # 定义db_data卷
  weaviate_data: {} # 定义 weaviate_data 卷
